<html>
<head>
<script>
const fetch = require('isomorphic-fetch');
const jsdom = require("jsdom");
const fs = require('fs');
const { JSDOM } = jsdom;

async function newsFeedDateHasChanged(){
  
  try{
    const response = await fetch('https://www.aonsrd.com/');
    const text = await response.text();
    const dom = await new JSDOM(text);
    const mainPage = dom.window.document.getElementById('ctl00_MainContent_MainNewsFeed');
    //NOTE: might need to look into a better way of selecting the date of the main page
    let newPageDate = mainPage.textContent.slice(0,19);
    oldPageDate = fetchRaceListDate();
    if(newPageDate != oldPageDate){
      fs.writeFile('RaceList.txt', newPageDate, (err) => {
        if (err) throw err;
      })
      return true;
    }
    return false;
  }catch(err){
    document.getElementById("output").innerHTML = err;
    return false;
  }
}

function fetchRaceListDate(){
  try{
    fs.readFile("./RaceList.txt", 'utf8', function(err, data){
      var ret = data.split('\n');
      return ret[0];
  });
  }catch (e){
    document.getElementById("output").innerHTML = "reason for failure";
    document.getElementById("output").innerHTML = e;
    return [""];
  }
}

async function scrapeRaces(){
  if(!newsFeedDateHasChanged()){
    return;
  }else{
    try{
        const response = await fetch('https://www.aonsrd.com/Races.aspx?ItemName=All');
        const text = await response.text();
        const dom = await new JSDOM(text);
        const raceElements = dom.window.document.getElementById('ctl00_MainContent_AllRacesList');
        let raceList = raceElements.getElementsByTagName("a");

        for(let i = 0; i < raceList.length; i++){
          //document.getElementById("output").innerHTML = raceList[i].textContent;
          fs.appendFile('RaceList.txt', raceList[i].textContent+'\n', (err) => {
            if (err) throw err;
          })
        }
        return raceList;
      }catch(err){
        document.getElementById("output").innerHTML = err;
      }
    }
}

function getRaceListFile(){
  window.alert("HELLO!");
  try{
    window.fs.readFile("RaceList.txt", 'utf8', function(err, data){
      var ret = data.split('\n');
      document.getElementById("output").innerHTML = ret;
      return ret;
  });
  }catch (e){
    document.getElementById("output").innerHTML = e;
    return [""];
  }
}

async function getRandomRace(){
  let allRaces = await getRaceListFile();
  //TODO: type of allRaces is undefined?!
  if(allRaces.length == 0){
    window.alert("read file failed, reading from scraped list")
    allRaces = await scrapeRaces();
  }
  window.alert(allRaces[Math.floor(Math.random()*allRaces.length)].textContent);
}

</script>
</head>

<body>
<h1><span id="output">Random Race</span></h1>
<input type = "button" onclick = "getRandomRace()" value = "Print Random Race">  
</body>

</html>
